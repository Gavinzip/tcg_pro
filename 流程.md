# TCG 卡片精準搜尋與驗證流程 (Search & Verification Logic)

本文件詳細說明系統如何從圖片辨識到最終定位市場行情的邏輯，確保即使在編號重複或 AI 幻覺的情況下，也能找到正確卡片。

---

## 1. 核心邏輯架構
尋找卡片的過程分為三個階段：**辨識 (Identify)**、**搜尋 (Search)**、**驗證 (Verify)**。
`main` 與 `tcg_pro` 兩個版本的「搜尋與驗證」物理邏輯是完全同步的。

### A. 辨識 (Identity) - Minimax Vision AI
- **輸入**：原始卡片圖片。
- **輸出**：13 個關鍵欄位 (JSON)，包括 `name`, `set_code`, `number`, `is_alt_art` 等。
- **容錯處理**：
    - 若編號僅有數字與斜線（如 `004/SV-P`），系統會自動拆分 `set_code` 與 `number`。
    - **英文/中文切換**：`tcg_pro` 支援語言選擇，影響 AI 描述欄位 (Market Heat 等) 的語言。

---

## 2. PriceCharting 搜尋邏輯 (PC Search)

為了防止如「傘電蜥 #201」誤抓成「噴火龍 #201」的情況，系統採用了名為 **"Name-Slug strict filtering"** 的驗證機制。

### 步驟：
1. **清理編號**：將 `023/108` 簡化為 `23`，移除前導零。
2. **多重查詢策略**：
    - 查詢 1: `[Name] + [Set Code] + [Number]`
    - 查詢 2: `[Name] + [Number]`
3. **URL 篩選與優先級 (Verification Logic)**：
    從搜尋結果中提取所有 `/game/...` 連結，並按以下優先順位排序：
    - **第一優先**：URL 的結尾同時包含 `卡名 (slug)` 與 `正確編號`。
    - **第二優先**：URL 包含 `卡名 (slug)`。
    - **第三優先**：URL 包含 `正確編號`（且若有 `set_code` 則必須吻合）。
4. **版本過濾 (is_alt_art)**：
    - 若 `is_alt_art` 為 True：必須包含 `manga`, `parallel`, `alt-art` 等字眼。
    - 若為 False：排除上述字眼。

---

## 3. SNKRDUNK 搜尋邏輯 (SNKR Search)

SNKRDUNK 的搜尋更為嚴格，因為日版卡片通常有固定的補零填充 (Padding)。

### 步驟：
1. **編號補零 (Padding)**：將 `4` 補為 `004`，因為 SNKRDUNK 標題慣用三位數。
2. **橫槓容錯 (Hyphen Tolerance)**：
    - 針對 `SV-P` 這類系列，會自動嘗試 `SV-P` 和 `SVP` 兩種關鍵字搜尋。
3. **標題解析驗證**：
    - 必須在搜尋結果標題中找到 `004` (Padded) 或 `4/` (Original/Total)。
    - **系列代號強制檢查**：如果 AI 辨識出 `set_code`，則該代號必須出現在 SNKRDUNK 標題中。
4. **語言處理**：優先使用 `jp_name` (日文名) 進行搜尋，效果最準。

---

## 4. 版本差異說明

雖然搜尋邏輯一樣，但抓取後的處理略有不同：

| 功能 | `main` | `tcg_pro` |
|---|---|---|
| **搜尋 & 驗證** | ✅ 相同 (同步至最新版) | ✅ 相同 (同步至最新版) |
| **資料過濾** | 查詢時傳入 `target_grade`，由查詢函數過濾。 | 查詢回傳所有等級，由外部控制如何顯示。 |
| **輸出格式** | 純文字 Markdown 報告。 | Markdown + 兩款動態 HTML 生成的海報 (Poster)。 |
| **輸出路徑** | 預設 `/report`。 | 預設 `/tcg_pro/output_run/` (或暫存區)。 |

---

## 5. 常見問題修復 (Debug History)
- **#201 誤抓事件**：修正了只驗證編號導致抓到高權重噴火龍的問題，現在強制驗證卡名。
- **SV-P 搜尋不到**：修正了爬蟲對橫槓敏感的問題，改為雙重搜尋。
- **Minimax SV-P 偏見**：修正了 Prompt 範例誤導 AI 將所有 Promo 都猜成 SV-P 的問題。
